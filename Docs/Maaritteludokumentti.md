
# Johdanto

Johdannossa kerrotaan minimaaliset taustatiedot ongelman ymmärtämiseksi. Lukija
joka on sinut (japanilaisen) mahjongin ja muutamien sen termien kanssa (tenpai,
shanten) voi haluta ohittaa sen.  Mahjongin laajahkoa pelimekaniikkaa ei
tarvitse tietää ongelman ymmärtämiseksi.

(Riichi) mahjong on neljän ihmisen pokeria muistuttava peli, jota pelataan
kaikkiaan 136:lla tiilellä. Jokaista tiiltä on pelissä neljä samanlaista.
Tiilistä muodostuu kolme maata (man, pin, shuu) joista kustakin on edustettuna
numerotiilet 1-9. Lisäksi on neljä ilmasuuntatiiltä (itä, etelä, länsi,
pohjoinen) ja kolme lohikäärmetiiltä.

## Mahjong-käsi

Valmis mahjong-käsi koostuu (vähintään) 14 **tiilestä**, jotka muodostavat
(yleensä) 4 **settiä** ja yhden **parin**.

Settejä on kolmea eri tyyppiä.

1. Kolmikko: kolme samaa tiiltä (**koutsu**), esimerkiksi:

   ![](http://upload.wikimedia.org/wikipedia/commons/4/4a/MJt1.png)
   ![](http://upload.wikimedia.org/wikipedia/commons/4/4a/MJt1.png)
   ![](http://upload.wikimedia.org/wikipedia/commons/4/4a/MJt1.png)

2. Nelikko: neljä samaa tiiltä (**kantsu**):
   
   ![](http://upload.wikimedia.org/wikipedia/commons/b/bf/MJs5.png)
   ![](http://upload.wikimedia.org/wikipedia/commons/b/bf/MJs5.png)
   ![](http://upload.wikimedia.org/wikipedia/commons/b/bf/MJs5.png)
   ![](http://upload.wikimedia.org/wikipedia/commons/b/bf/MJs5.png)

3. Suora: Kolmen tiilen suora (**shuntsu**):

   ![](http://upload.wikimedia.org/wikipedia/commons/1/1c/MJw1.png)
   ![](http://upload.wikimedia.org/wikipedia/commons/c/c3/MJw2.png)
   ![](http://upload.wikimedia.org/wikipedia/commons/9/9e/MJw3.png)

Pari (**jantou**) muodostuu mistä vain kahdesta samanlaisesta tiilestä.

Esimerkki valmiista kädestä:

![](http://upload.wikimedia.org/wikipedia/commons/1/1c/MJw1.png)
![](http://upload.wikimedia.org/wikipedia/commons/1/1c/MJw1.png)
![](http://upload.wikimedia.org/wikipedia/commons/1/1c/MJw1.png)
![](http://upload.wikimedia.org/wikipedia/commons/e/ed/MJw5.png)
![](http://upload.wikimedia.org/wikipedia/commons/e/ed/MJw5.png)
![](http://upload.wikimedia.org/wikipedia/commons/e/ed/MJw5.png)
![](http://upload.wikimedia.org/wikipedia/commons/d/df/MJs4.png)
![](http://upload.wikimedia.org/wikipedia/commons/b/bf/MJs5.png)
![](http://upload.wikimedia.org/wikipedia/commons/c/cb/MJs6.png)
![](http://upload.wikimedia.org/wikipedia/commons/d/dc/MJf3.png)
![](http://upload.wikimedia.org/wikipedia/commons/d/dc/MJf3.png)
![](http://upload.wikimedia.org/wikipedia/commons/d/dc/MJf3.png)
![](http://upload.wikimedia.org/wikipedia/commons/1/1b/MJd1.png)
![](http://upload.wikimedia.org/wikipedia/commons/1/1b/MJd1.png)

Käden setit ovat: 1-man koutsu, 5-man koutsu, 456-bambu shuntsu, länsikolmoset
ja pari punaisia lohikäärmeitä.

## Tenpai

Mahjong muistuttaa hyvin paljon pokeria: pelaajat aloittavat kädellä, jossa on
13 satunnaisesti nostettua tiiltä. Pelaaja muokkaa kättään aina yksi tiili
kerrallaan.  Vuorollaan hän nostaa käteensä muurista yhden tiilen lisää ja
heittää yhden tiilen pois (joka voi olla myös nostettu tiili), tavoitteenaan
päästä lähemmäs valmista kättä. Pelaaja voi myös *huutaa* tiilen, jonka toinen
pelaaja on juuri heittänyt pois. Tiilen voi huutaa jos se täydentää jonkin
kolmen tiilen setin. Setti paljastetaan muille huudon yhteydessä.

Huomaa, että valmiiseen käteen vaaditaan 14 tiiltä, mutta pelatessa kädessä on
vain 13 tiiltä. Käsi valmistuu, kun sopiva 14. tiili lisätään ja käsi
paljastetaan muille. Eli kun pelaaja nostaa (tai huutaa) käden viimeistelevän
tiilen, hän ei heitä sitä pois vaan julistaa voittonsa ja paljastaa kätensä.

Kun käsi valmistuisi lisäämällä siihen jokin 14. tiili, sanotaan että käsi (tai
pelaaja) on **tenpai**, yhden päässä voitosta.

Esimerkki tenpai-kädestä, joka voi voittaa joko 4- tai 7-bambulla:

![](http://upload.wikimedia.org/wikipedia/commons/1/1c/MJw1.png)
![](http://upload.wikimedia.org/wikipedia/commons/1/1c/MJw1.png)
![](http://upload.wikimedia.org/wikipedia/commons/1/1c/MJw1.png)
![](http://upload.wikimedia.org/wikipedia/commons/e/ed/MJw5.png)
![](http://upload.wikimedia.org/wikipedia/commons/e/ed/MJw5.png)
![](http://upload.wikimedia.org/wikipedia/commons/e/ed/MJw5.png)
![](http://upload.wikimedia.org/wikipedia/commons/b/bf/MJs5.png)
![](http://upload.wikimedia.org/wikipedia/commons/c/cb/MJs6.png)
![](http://upload.wikimedia.org/wikipedia/commons/d/dc/MJf3.png)
![](http://upload.wikimedia.org/wikipedia/commons/d/dc/MJf3.png)
![](http://upload.wikimedia.org/wikipedia/commons/d/dc/MJf3.png)
![](http://upload.wikimedia.org/wikipedia/commons/1/1b/MJd1.png)
![](http://upload.wikimedia.org/wikipedia/commons/1/1b/MJd1.png)

## Shanten

Kun tenpailla tarkoitetaan, että käsi on yhden päässä voitosta, niin
***n*-shanten** tarkoittaa että käsi on *n* tiilen päässä voitosta.

## Odotukset

Tässä työssä *odotuksilla tarkoitetaan mitä vain sellaista tiiltä, jonka
vaihtamalla jonkin kädessä olevan tiilen tilalle vie kättä lähemmäs tenpaita
(tai tenpai-käden voittoon). Huomaa, että tämä on yhtäpitävää shanten-arvon
pienentämisen kanssa.

# Työn tavoitteet

Tämän työn pääpaino on seuraavien mielivaltaisia mahjong-käsiä käsittelevien
algoritmien keksiminen ja toteutus:

- Algoritmi `setsOfHand`: käden kaikki setit ja mahdolliset setit (parit)
- Algoritmi `shanten`: shanten-arvo nk. vähennysmenetelmällä (katso alla)
- Algoritmi `waitsToWin`: selvitä käden ns. *välittömien odotusten puu* (katso
  määrittely alta)

Työ toteutetaan staattisesti tyypitetyllä, puhtaalla ja funktionaalisella
ohjelmointikielellä Haskell.

Ainoat käytetyt valmiit tietorakenteet ovat primitiivit ja (funktionaalisuuden
myötä) linkitetyt listat.  Muut (apu)tietorakenteet ja -algoritmit toteutetaan
itse.

Mahjong-tiilen esitys on triviaali summatyyppi, ja "varastetaan" tekijän omasta
[hajong](https://github.com/SimSaladin/hajong)-projektista.  Käsi on joukko n.
13 tiilestä, joten se voidaan käyttötarkoitus huomioon ottaen esittää listana
tiiliä.

Työn olennaisin ja mielenkiintoisin tietorakenne on `waitsToWin`-algoritmin
palauttama **odotuspuu**. Odotuspuu on ruusupuu, ja kurssin tavoitteiden
mukaisesti implementoidaan työssä.

# Algoritmi 1: Setit ja mahdolliset setit

Tämä on shanten-algoritmien (alla) ja odotustiilten määrittämistä varten
oleellinen algoritmi.

**Syöte:** mielivaltainen mahjong-käsi
<br>
**Tuloste:** käden setit ja/tai mahdolliset setit (Huom! mahdollisuuksia voi olla monta)
<br>
**Avut:** Algoritmi tiilten järjestämiseen maan ja numeron perusteella, ja tähän
sopiva tietorakenne (minimikeko?).

Miten mielivaltaisesta kokoelmasta mahjong-tiiliä saadaan selville kolmikot,
nelikot, suorat ja pari? Entä ne tiiliparit, joista muodostuisi setti
korvaamalla jokin muu tiili jollain toisella tiilellä?

Ongelma on itseasiassa aika mielenkiintoinen, sillä jako (kandidaatti)setteihin
ei aina ole yksikäsitteinen, sillä esimerkiksi seuraavat tiilet muodostavat
kaksi koutsua (444 ja 555) ja parin (66), tai kaksi shuntsua (456) ja yhden
shuntsu-odotuksen (45):

![](http://upload.wikimedia.org/wikipedia/commons/d/df/MJs4.png)
![](http://upload.wikimedia.org/wikipedia/commons/d/df/MJs4.png)
![](http://upload.wikimedia.org/wikipedia/commons/d/df/MJs4.png)
![](http://upload.wikimedia.org/wikipedia/commons/b/bf/MJs5.png)
![](http://upload.wikimedia.org/wikipedia/commons/b/bf/MJs5.png)
![](http://upload.wikimedia.org/wikipedia/commons/b/bf/MJs5.png)
![](http://upload.wikimedia.org/wikipedia/commons/c/cb/MJs6.png)
![](http://upload.wikimedia.org/wikipedia/commons/c/cb/MJs6.png)

# Algoritmi 2: Shanten-arvo (nk. vähennysmenetelmällä)

**Syöte:** Mielivaltainen mahjong-käsi.
<br>
**Tuloste:** Shanten-arvo.
<br>
**Avut:** (kandidaatti)-settien määrittäminen (Algoritmi 1).

Vähennysmenetelmä on varsin nerokas, nopea ja kognitiivisestikin helppo tapa
shantenin laskemiseen. Se on kuvattu tässä [StackOverflow-vastauksessa]
[vahennys].  Lyhyesti:

> Luvusta 8 vähennetään 2 jokaista valmista settiä kohden ja 1 jokaista yhtä
> vaille valmista settiä kohden. Jokainen tiili saa liittyä vain yhteen
> vähennykseen.

Ei ole aivan ilmiselvää, että vähennysmenetelmä todellakin toimii aina, ja olisi
mielenkiintoista nähdä formaali todistus että näin todellakin on.
Intuitiivisesti menetelmä tuntuu korrektilta.

[vahennys]: http://boardgames.stackexchange.com/questions/11877/how-can-i-quickly-calculate-the-shanten-number-in-mahjong#answer-13592
[hajong]:   http://github.com/SimSaladin/hajong

# Algoritmi 3: Odotuspuut

**Syöte:** Mielivaltainen mahjong-käsi.
<br>
**Tuloste:** Käden odotuspuu.

Odotuspuun määrittäminen on koko työn mielenkiintoisin algoritmi.

Odotuspuu esittää kaikki ne vaihtoehtoiset yhden tiilen vaihdot kädessä, jotka
pienentävät shantenia. Puu rakentuu seuraavasti:

> Puun alkiot ovat kolmikkoja `(edellinen heitto, nosto, heitettävät)`, missä
> `edellinen heitto` on edellisellä vuorolla poisheitetty tiili, `nosto`
> nykyisellä vuorolla nostettu tiili ja `heitettävät` niiden kädessä olevien
> tiilten joukko, joista mikä vain voidaan korvata nostetulla ja shanten kasvaa
> (tai pysyy samana).
> 
> Alkiot kuvaavat jotain mahjong-kättä: juuressa on kuvattuna alkuperäinen käsi
> ja jokainen lapsi kuvaa vanhempansa kättä, johon on lisätty tiili `nosto` ja
> poistettu tiili `edellinen heitto`.
>
> Kombinatorillisen räjähdyksen välttämiseksi vaaditaan, että `shanten(n) >=
> shanten(n+1)`, eli että lapsen shanten ei saa olla isompi kuin sen vanhemman.

Odotuspuu on siis naiivi esitys kaikista niistä yhden tiilen vaihdoista jotka
vievät kättä valmiimmaksi.

Huomaa, että tästä puusta saadaan ilmaiseksi hyvin yksinkertainen
mahjong-tekoäly: mikäli nostettu tiili on puun ensimmäisellä tasolla `nosto`:na:
siirrä nostettu tiili käteen ja heitä satunnaisesti jokin tiili
`heitettävät`-kokoelmasta. Muuten heitä nostettu tiili pois. Ja kun puussa
liikkuu syvemmälle voi esimerkiksi määrittää melko halvasti heuristiikkoja kuten
eri odotusten maksimointi, odotusten todennäköisyydet muiden poisheitoista,
fu-pisteiden maksimointi jne.

Tekoälyn toteutus on kuitenkin toissijaista ja siihen mennään mikäli tulee
tylsää.
